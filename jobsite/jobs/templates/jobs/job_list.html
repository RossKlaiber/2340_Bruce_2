{% extends 'base.html' %}
{% block content %}
<div class="p-3 mt-4">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2>{% if template_data.recommended %}Recommended Jobs{% else %}Job Listings{% endif %}</h2>
            {% if template_data.total_jobs %}
            <small class="text-muted">{{ template_data.total_jobs }} job{{ template_data.total_jobs|pluralize }}
              found</small>
            {% endif %}
          </div>
          {% if user.is_authenticated and user.profile.is_recruiter %}
          <a href="{% url 'jobs.create' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Post a Job
          </a>
          {% endif %}
        </div>

        <!-- Enhanced Search and Filter Form -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-search"></i> Search & Filter Jobs</h5>
          </div>
          <div class="card-body">
            <form method="GET" id="jobSearchForm">
              <!-- First Row: Main Search and Location -->
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <label for="{{ template_data.search_form.search.id_for_label }}" class="form-label">Search</label>
                  {{ template_data.search_form.search }}
                  <div class="form-text">Search by job title, company, location, skills, or description</div>
                </div>
                <div class="col-md-6">
                  <label for="{{ template_data.search_form.location.id_for_label }}" class="form-label">Location</label>
                  {{ template_data.search_form.location }}
                  <div class="form-text">City, state, or country</div>
                </div>
              </div>

              <!-- Second Row: Skills and Job Type -->
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <label for="{{ template_data.search_form.skills.id_for_label }}" class="form-label">Skills</label>
                  {{ template_data.search_form.skills }}
                  <div class="form-text">Comma-separated list of skills</div>
                </div>
                <div class="col-md-3">
                  <label for="{{ template_data.search_form.job_type.id_for_label }}" class="form-label">Job Type</label>
                  {{ template_data.search_form.job_type }}
                </div>
                <div class="col-md-3">
                  <label for="{{ template_data.search_form.experience_level.id_for_label }}"
                    class="form-label">Experience</label>
                  {{ template_data.search_form.experience_level }}
                </div>
              </div>

              <!-- Third Row: Work Type, Salary Range, and Visa -->
              <div class="row g-3 mb-3">
                <div class="col-md-3">
                  <label for="{{ template_data.search_form.work_type.id_for_label }}" class="form-label">Work
                    Type</label>
                  {{ template_data.search_form.work_type }}
                </div>
                <div class="col-md-3">
                  <label for="{{ template_data.search_form.salary_min.id_for_label }}" class="form-label">Min
                    Salary</label>
                  {{ template_data.search_form.salary_min }}
                </div>
                <div class="col-md-3">
                  <label for="{{ template_data.search_form.salary_max.id_for_label }}" class="form-label">Max
                    Salary</label>
                  {{ template_data.search_form.salary_max }}
                </div>
                <div class="col-md-3">
                  <div class="form-check mt-md-4 pt-md-3">
                    {{ template_data.search_form.visa_sponsorship }}
                    <label for="{{ template_data.search_form.visa_sponsorship.id_for_label }}" class="form-check-label">
                      Visa Sponsorship
                    </label>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="row g-3">
                <div class="col-12">
                  <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search"></i> Search Jobs
                  </button>
                  <a href="{% url 'jobs.list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Clear Filters
                  </a>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- View Toggle Tabs -->
        <div class="card mb-4">
          <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="jobViewTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-view" type="button" role="tab" aria-controls="list-view" aria-selected="true">
                  <i class="fas fa-list"></i> List View
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-view" type="button" role="tab" aria-controls="map-view" aria-selected="false">
                  <i class="fas fa-map"></i> Map View
                </button>
              </li>
            </ul>
          </div>
          <div class="card-body">
            <div class="tab-content" id="jobViewTabContent">
              <!-- List View Tab -->
              <div class="tab-pane fade show active" id="list-view" role="tabpanel" aria-labelledby="list-tab">
                <!-- Job Listings -->
                {% if template_data.page_obj %}
        <div class="row">
          {% for job in template_data.page_obj %}
          <div class="col-lg-6 mb-3">
            <div class="card h-100">
              <div class="card-body d-flex flex-column">

                <div class="row">
                  <div class="col-md-12">
                    <div class="d-flex gap-2 justify-content-between">
                      <div>
                        <h4 class="card-title">
                          <a href="{% url 'jobs.detail' job.id %}" class="text-decoration-none">
                            {{ job.title }}
                          </a>
                        </h4>
                        <h6 class="card-subtitle mb-1 text-muted">{{ job.company }}</h6>
                      </div>
                      <div class="d-flex flex-column align-items-end">
                        <span class="badge bg-success fs-6 mb-1">{{ job.salary_range }}</span>
                        <small class="text-muted">Posted {{ job.created_at|timesince }} ago</small>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row d-flex flex-column flex-grow-1 my-1">
                  <div class="col-md-12 flex-grow-1">
                    <p class="card-text">
                      <i class="fas fa-map-marker-alt"></i> {{ job.location }} |
                      <i class="fas fa-briefcase"></i> {{ job.get_job_type_display }} |
                      <i class="fas fa-user-tie"></i> {{ job.get_experience_level_display }} |
                      <i class="fas fa-home"></i> {{ job.get_work_type_display }}
                      {% if job.visa_sponsorship %}
                      | <span class="badge bg-info">Visa Sponsorship</span>
                      {% endif %}
                    </p>
                    {% if job.skills_list %}
                    <p class="card-text">
                      <strong>Skills:</strong>
                      {% for skill in job.skills_list %}
                      <span class="badge bg-secondary me-1">{{ skill }}</span>
                      {% endfor %}
                    </p>
                    {% endif %}
                    <p class="card-text">{{ job.description|truncatewords:30 }}</p>
                  </div>
                  <div class="col-md-12">
                    <div class="mt-3">
                      <a href="{% url 'jobs.detail' job.id %}" class="btn btn-outline-primary btn-sm me-2">
                        View Details
                      </a>
                      {% if user.is_authenticated and user.profile.is_job_seeker %}
                      {% if job.has_applied %}
                      <button class="btn btn-success btn-sm" disabled>
                        <i class="fas fa-check"></i> Applied
                      </button>
                      {% else %}
                      <button class="btn btn-primary btn-sm apply-now-btn" data-job-id="{{ job.id }}"
                        data-job-title="{{ job.title }}" data-company="{{ job.company }}">
                        <i class="fas fa-paper-plane"></i> Apply Now
                      </button>
                      {% endif %}
                      {% endif %}
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Pagination -->
        {% if template_data.page_obj.has_other_pages %}
        <nav aria-label="Job listings pagination">
          <ul class="pagination justify-content-center">
            {% if template_data.page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                href="?page={{ template_data.page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
            </li>
            {% endif %}

            {% for num in template_data.page_obj.paginator.page_range %}
            {% if template_data.page_obj.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
            {% elif num > template_data.page_obj.number|add:'-3' and num < template_data.page_obj.number|add:'3' %} <li
              class="page-item">
                <a class="page-link"
                  href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                  {{ num }}
                </a>
              </li>
              {% endif %}
              {% endfor %}

              {% if template_data.page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                  href="?page={{ template_data.page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
              </li>
              {% endif %}
          </ul>
        </nav>
        {% endif %}

                {% else %}
                <div class="text-center py-5">
                  <i class="fas fa-search fa-3x text-muted mb-3"></i>
                  <h4>No jobs found</h4>
                  <p class="text-muted">Try adjusting your search criteria or check back later for new opportunities.</p>
                </div>
                {% endif %}
              </div>
              
              <!-- Map View Tab -->
              <div class="tab-pane fade" id="map-view" role="tabpanel" aria-labelledby="map-tab">
                <div class="row">
                  <div class="col-12">
                    <!-- Location Prompt -->
                    <div id="location-prompt" class="alert alert-info mb-3">
                      <h5><i class="fas fa-map-marker-alt"></i> Enable Location Access</h5>
                      <p class="mb-3">Allow your browser to access your location to see jobs on the map relative to where you are:</p>
                      <div class="row">
                        <div class="col-md-6">
                          <button id="enable-location-btn" class="btn btn-primary w-100">
                            <i class="fas fa-location-arrow"></i> Use My Current Location
                          </button>
                        </div>
                        <div class="col-md-6">
                          <button id="manual-location-btn" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-map-marker-alt"></i> Enter Location Manually
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Manual Location Input (Hidden by default) -->
                    <div id="manual-location-input" class="alert alert-secondary mb-3" style="display: none;">
                      <h5><i class="fas fa-map-marker-alt"></i> Enter Your Location</h5>
                      <p class="mb-3">Enter your location to see jobs on the map:</p>
                      <div class="row">
                        <div class="col-md-8">
                          <input type="text" id="user-location-input" class="form-control" placeholder="Enter your city, state, or address">
                        </div>
                        <div class="col-md-4">
                          <button id="set-manual-location-btn" class="btn btn-primary w-100">
                            <i class="fas fa-map-marker-alt"></i> Set Location
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="jobs-map" style="height: 500px; width: 100%; border: 1px solid #ddd; border-radius: 5px; display: none;"></div>
                    
                    <!-- Map Info -->
                    <div id="map-info" class="mt-3" style="display: none;">
                      <div class="row">
                        <div class="col-md-6">
                          <p><strong>Your Location:</strong> <span id="user-location-display"></span></p>
                        </div>
                        <div class="col-md-6">
                          <p><strong>Jobs Found:</strong> <span id="jobs-count"></span></p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Application Modal -->
<div class="modal fade" id="applicationModal" tabindex="-1" aria-labelledby="applicationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="applicationModalLabel">Apply for Position</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="applicationForm">
        <div class="modal-body">
          {% csrf_token %}
          <div class="mb-3">
            <strong id="jobTitleDisplay"></strong>
            <br>
            <small class="text-muted" id="companyDisplay"></small>
          </div>
          <div class="mb-3">
            <label for="coverNote" class="form-label">Cover Note *</label>
            <textarea class="form-control" id="coverNote" name="cover_note" rows="4"
              placeholder="Tell the employer why you're interested in this position and why you'd be a great fit..."
              required></textarea>
            <div class="form-text">Write a personalized note to accompany your application</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Submit Application
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const applyButtons = document.querySelectorAll('.apply-now-btn');
    const applicationModal = new bootstrap.Modal(document.getElementById('applicationModal'));
    const applicationForm = document.getElementById('applicationForm');
    const jobTitleDisplay = document.getElementById('jobTitleDisplay');
    const companyDisplay = document.getElementById('companyDisplay');
    const coverNoteTextarea = document.getElementById('coverNote');

    let currentJobId = null;

    // Handle Apply Now button clicks
    applyButtons.forEach(button => {
      button.addEventListener('click', function () {
        currentJobId = this.dataset.jobId;
        const jobTitle = this.dataset.jobTitle;
        const company = this.dataset.company;

        jobTitleDisplay.textContent = jobTitle;
        companyDisplay.textContent = company;
        coverNoteTextarea.value = '';

        applicationModal.show();
      });
    });

    // Handle form submission
    applicationForm.addEventListener('submit', function (e) {
      e.preventDefault();

      if (!currentJobId) return;

      const formData = new FormData();
      formData.append('cover_note', coverNoteTextarea.value);
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

      // Disable submit button
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
      submitBtn.disabled = true;

      fetch(`/jobs/${currentJobId}/apply/`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            applicationModal.hide();
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                    <strong>Success!</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);

            // Update the button to show applied status
            const appliedButton = document.querySelector(`[data-job-id="${currentJobId}"]`);
            if (appliedButton) {
              appliedButton.innerHTML = '<i class="fas fa-check"></i> Applied';
              appliedButton.classList.remove('btn-primary');
              appliedButton.classList.add('btn-success');
              appliedButton.disabled = true;
            }
          } else {
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                    <strong>Error!</strong> ${data.error}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
            applicationModal.hide();
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-danger alert-dismissible fade show';
          alertDiv.innerHTML = `
                <strong>Error!</strong> Something went wrong. Please try again.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
          applicationModal.hide();
          document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
        })
        .finally(() => {
          // Re-enable submit button
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
    });
  });
</script>

<!-- Google Places Autocomplete for Search -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>
<script>
function initAutocomplete() {
    // Initialize autocomplete for location search
    const locationInput = document.getElementById('location-search-input');
    if (locationInput) {
        const locationAutocomplete = new google.maps.places.Autocomplete(locationInput, {
            types: ['geocode'], // Only return geocoding results (addresses)
            componentRestrictions: { country: 'us' } // Restrict to US addresses
        });
        
        // When a place is selected, update the input
        locationAutocomplete.addListener('place_changed', function() {
            const place = locationAutocomplete.getPlace();
            if (place.formatted_address) {
                locationInput.value = place.formatted_address;
            }
        });
    }
    
    // Initialize autocomplete for general search (companies, job titles, etc.)
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        const searchAutocomplete = new google.maps.places.Autocomplete(searchInput, {
            types: ['establishment'], // Focus on businesses/establishments
            componentRestrictions: { country: 'us' }
        });
        
        // When a place is selected, update the input
        searchAutocomplete.addListener('place_changed', function() {
            const place = searchAutocomplete.getPlace();
            if (place.name) {
                searchInput.value = place.name;
            }
        });
    }
    
    // Initialize autocomplete for user location input in map view
    const userLocationInput = document.getElementById('user-location-input');
    if (userLocationInput) {
        const userLocationAutocomplete = new google.maps.places.Autocomplete(userLocationInput, {
            types: ['geocode'],
            componentRestrictions: { country: 'us' }
        });
        
        // When a place is selected, update the input
        userLocationAutocomplete.addListener('place_changed', function() {
            const place = userLocationAutocomplete.getPlace();
            if (place.formatted_address) {
                userLocationInput.value = place.formatted_address;
            }
        });
    }
}

// Initialize autocomplete when page loads
google.maps.event.addDomListener(window, 'load', initAutocomplete);

// Map View Functionality
let jobsMap;
let userLocationMarker;
let jobMarkers = [];
let userLocation = null;
let geocoder;

// Job data from Django template
// eslint-disable-next-line
const jobsData = [
  {% for job in template_data.page_obj %}
    {% if job.has_coordinates %}
    {
      id: {{ job.id }},
      title: "{{ job.title|escapejs }}",
      company: "{{ job.company|escapejs }}",
      location: "{{ job.location|escapejs }}",
      latitude: {{ job.latitude }},
      longitude: {{ job.longitude }},
      jobType: "{{ job.get_job_type_display|escapejs }}",
      experienceLevel: "{{ job.get_experience_level_display|escapejs }}",
      workType: "{{ job.get_work_type_display|escapejs }}",
      salaryRange: "{{ job.salary_range|escapejs }}",
      url: "{% url 'jobs.detail' job.id %}"
    }{% if not forloop.last %},{% endif %}
    {% endif %}
  {% endfor %}
];

function initJobsMap() {
  geocoder = new google.maps.Geocoder();
  
  // Initialize the map
  jobsMap = new google.maps.Map(document.getElementById('jobs-map'), {
    zoom: 10,
    center: { lat: 37.7749, lng: -122.4194 }, // Default to San Francisco
    mapTypeControl: true,
    streetViewControl: true,
    fullscreenControl: true
  });
  
  // Add job markers to map
  addJobMarkers();
  
  // Show map and info
  document.getElementById('jobs-map').style.display = 'block';
  document.getElementById('map-info').style.display = 'block';
  document.getElementById('jobs-count').textContent = jobsData.length;
}

function addJobMarkers() {
  // Clear existing job markers
  jobMarkers.forEach(marker => marker.setMap(null));
  jobMarkers = [];
  
  jobsData.forEach(job => {
    const marker = new google.maps.Marker({
      position: { lat: job.latitude, lng: job.longitude },
      map: jobsMap,
      title: `${job.title} at ${job.company}`,
      icon: {
        url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
      }
    });
    
    // Create info window content
    const infoWindow = new google.maps.InfoWindow({
      content: `
        <div style="padding: 10px; max-width: 300px;">
          <h6><strong>${job.title}</strong></h6>
          <p style="margin: 5px 0; color: #666;"><strong>${job.company}</strong></p>
          <p style="margin: 5px 0;"><i class="fas fa-map-marker-alt"></i> ${job.location}</p>
          <p style="margin: 5px 0;"><i class="fas fa-briefcase"></i> ${job.jobType}</p>
          <p style="margin: 5px 0;"><i class="fas fa-user-tie"></i> ${job.experienceLevel}</p>
          <p style="margin: 5px 0;"><i class="fas fa-home"></i> ${job.workType}</p>
          <p style="margin: 5px 0;"><i class="fas fa-dollar-sign"></i> ${job.salaryRange}</p>
          <div style="margin-top: 10px;">
            <a href="${job.url}" class="btn btn-primary btn-sm" target="_blank">
              <i class="fas fa-eye"></i> View Job
            </a>
          </div>
        </div>
      `
    });
    
    // Add click listener to marker
    marker.addListener('click', function() {
      infoWindow.open(jobsMap, marker);
    });
    
    jobMarkers.push(marker);
  });
}

function enableCurrentLocation() {
  if (!navigator.geolocation) {
    alert('Geolocation is not supported by this browser. Please enter your location manually.');
    showManualLocationInput();
    return;
  }
  
  // Show loading state
  const enableBtn = document.getElementById('enable-location-btn');
  const originalText = enableBtn.innerHTML;
  enableBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
  enableBtn.disabled = true;
  
  navigator.geolocation.getCurrentPosition(
    function(position) {
      // Success callback
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      userLocation = new google.maps.LatLng(lat, lng);
      
      // Remove existing user location marker
      if (userLocationMarker) {
        userLocationMarker.setMap(null);
      }
      
      // Add user location marker
      userLocationMarker = new google.maps.Marker({
        position: userLocation,
        map: jobsMap,
        title: 'Your Current Location',
        icon: {
          url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
        },
        animation: google.maps.Animation.DROP
      });
      
      // Center map on user location
      jobsMap.setCenter(userLocation);
      jobsMap.setZoom(12);
      
      // Get address from coordinates
      geocoder.geocode({ location: userLocation }, function(results, status) {
        if (status === 'OK' && results[0]) {
          document.getElementById('user-location-display').textContent = results[0].formatted_address;
        } else {
          document.getElementById('user-location-display').textContent = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
        }
      });
      
      // Hide prompts and show map
      document.getElementById('location-prompt').style.display = 'none';
      document.getElementById('manual-location-input').style.display = 'none';
      
      // Calculate and display distances
      calculateDistances();
      
      // Reset button
      enableBtn.innerHTML = originalText;
      enableBtn.disabled = false;
    },
    function(error) {
      // Error callback
      let errorMessage = 'Unable to get your location. ';
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMessage += 'Location access denied. Please allow location access or enter your location manually.';
          break;
        case error.POSITION_UNAVAILABLE:
          errorMessage += 'Location information unavailable. Please enter your location manually.';
          break;
        case error.TIMEOUT:
          errorMessage += 'Location request timed out. Please try again or enter your location manually.';
          break;
        default:
          errorMessage += 'An unknown error occurred. Please enter your location manually.';
          break;
      }
      
      alert(errorMessage);
      showManualLocationInput();
      
      // Reset button
      enableBtn.innerHTML = originalText;
      enableBtn.disabled = false;
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 300000 // 5 minutes
    }
  );
}

function showManualLocationInput() {
  document.getElementById('location-prompt').style.display = 'none';
  document.getElementById('manual-location-input').style.display = 'block';
}

function setManualLocation() {
  const locationInput = document.getElementById('user-location-input').value;
  
  if (!locationInput.trim()) {
    alert('Please enter your location');
    return;
  }
  
  geocoder.geocode({ address: locationInput }, function(results, status) {
    if (status === 'OK' && results[0]) {
      userLocation = results[0].geometry.location;
      
      // Remove existing user location marker
      if (userLocationMarker) {
        userLocationMarker.setMap(null);
      }
      
      // Add user location marker
      userLocationMarker = new google.maps.Marker({
        position: userLocation,
        map: jobsMap,
        title: 'Your Location',
        icon: {
          url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
        },
        animation: google.maps.Animation.DROP
      });
      
      // Center map on user location
      jobsMap.setCenter(userLocation);
      jobsMap.setZoom(12);
      
      // Update UI
      document.getElementById('user-location-display').textContent = results[0].formatted_address;
      document.getElementById('manual-location-input').style.display = 'none';
      
      // Calculate and display distances
      calculateDistances();
      
    } else {
      alert('Location not found. Please try a different address.');
    }
  });
}

function calculateDistances() {
  if (!userLocation) return;
  
  const service = new google.maps.DistanceMatrixService();
  const destinations = jobsData.map(job => ({
    lat: job.latitude,
    lng: job.longitude
  }));
  
  service.getDistanceMatrix({
    origins: [userLocation],
    destinations: destinations,
    travelMode: google.maps.TravelMode.DRIVING,
    unitSystem: google.maps.UnitSystem.IMPERIAL,
    avoidHighways: false,
    avoidTolls: false
  }, function(response, status) {
    if (status === 'OK') {
      const elements = response.rows[0].elements;
      
      // Update job markers with distance info
      jobMarkers.forEach((marker, index) => {
        const job = jobsData[index];
        const element = elements[index];
        
        if (element.status === 'OK') {
          const distance = element.distance.text;
          const duration = element.duration.text;
          
          // Update marker title with distance
          marker.setTitle(`${job.title} at ${job.company} (${distance} away)`);
          
          // Update info window with distance
          const infoWindow = new google.maps.InfoWindow({
            content: `
              <div style="padding: 10px; max-width: 300px;">
                <h6><strong>${job.title}</strong></h6>
                <p style="margin: 5px 0; color: #666;"><strong>${job.company}</strong></p>
                <p style="margin: 5px 0;"><i class="fas fa-map-marker-alt"></i> ${job.location}</p>
                <p style="margin: 5px 0; color: #28a745;"><i class="fas fa-route"></i> ${distance} (${duration})</p>
                <p style="margin: 5px 0;"><i class="fas fa-briefcase"></i> ${job.jobType}</p>
                <p style="margin: 5px 0;"><i class="fas fa-user-tie"></i> ${job.experienceLevel}</p>
                <p style="margin: 5px 0;"><i class="fas fa-home"></i> ${job.workType}</p>
                <p style="margin: 5px 0;"><i class="fas fa-dollar-sign"></i> ${job.salaryRange}</p>
                <div style="margin-top: 10px;">
                  <a href="${job.url}" class="btn btn-primary btn-sm" target="_blank">
                    <i class="fas fa-eye"></i> View Job
                  </a>
                </div>
              </div>
            `
          });
          
          marker.addListener('click', function() {
            infoWindow.open(jobsMap, marker);
          });
        }
      });
    }
  });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Enable current location button
  document.getElementById('enable-location-btn').addEventListener('click', enableCurrentLocation);
  
  // Manual location button
  document.getElementById('manual-location-btn').addEventListener('click', showManualLocationInput);
  
  // Set manual location button
  document.getElementById('set-manual-location-btn').addEventListener('click', setManualLocation);
  
  // Enter key on manual location input
  document.getElementById('user-location-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      setManualLocation();
    }
  });
  
  // Tab change event
  document.getElementById('map-tab').addEventListener('shown.bs.tab', function() {
    if (!jobsMap) {
      initJobsMap();
    }
  });
});
</script>
{% endblock content %}