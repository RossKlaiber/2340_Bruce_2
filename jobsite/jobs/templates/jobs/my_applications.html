{% extends 'base.html' %}
{% block content %}
<div class="p-3 mt-4">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>My Job Applications</h2>
          <div>
            <span class="badge bg-primary fs-6">{{ template_data.total_applications }} Total Application{{ template_data.total_applications|pluralize }}</span>
            <a href="{% url 'jobs.list' %}" class="btn btn-outline-primary ms-2">
              <i class="fas fa-search"></i> Browse Jobs
            </a>
          </div>
        </div>
        
        {% if template_data.applications %}
        
        <!-- Toggle View Buttons -->
        <div class="mb-4">
          <div class="btn-group" role="group" aria-label="View toggle">
            <button type="button" class="btn btn-outline-primary active" id="boardViewBtn">
              <i class="fas fa-columns"></i> Board View
            </button>
            <button type="button" class="btn btn-outline-primary" id="listViewBtn">
              <i class="fas fa-list"></i> List View
            </button>
          </div>
        </div>

        <!-- Board View -->
        <div id="boardView">
          <div class="row g-2">
            {% for group in template_data.status_groups %}
            <div class="col mb-3 kanban-column" data-status="{{ group.code }}">
              <div class="card h-100">
                <div class="card-header bg-{{ group.color }} text-white">
                  <h6 class="card-title mb-0">
                    {{ group.name }}
                    <span class="badge bg-light text-dark ms-2 status-count" data-status="{{ group.code }}">{{ group.count }}</span>
                  </h6>
                </div>
                <div class="card-body p-2 kanban-drop-zone" data-status="{{ group.code }}" style="min-height: 200px;">
                  {% for application in group.applications %}
                  <div class="card mb-2 shadow-sm application-card" 
                       draggable="true"
                       data-application-id="{{ application.id }}"
                       data-status="{{ application.status }}">
                    <div class="card-body p-2">
                      <h6 class="card-title mb-1 text-truncate">
                        <i class="fas fa-grip-vertical text-muted me-1" style="cursor: move;"></i>
                        <a href="{% url 'jobs.detail' application.job.id %}" class="text-decoration-none">
                          {{ application.job.title }}
                        </a>
                      </h6>
                      <p class="card-text small text-muted mb-1">{{ application.job.company }}</p>
                      <p class="card-text small text-muted mb-1">
                        <i class="fas fa-map-marker-alt"></i> {{ application.job.location }}
                      </p>
                      <small class="text-muted">
                        Applied {{ application.applied_at|timesince }} ago
                      </small>
                    </div>
                  </div>
                  {% empty %}
                  <div class="text-center text-muted py-3 empty-message">
                    <i class="fas fa-inbox"></i>
                    <br>
                    <small>No applications</small>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- List View -->
        <div id="listView" style="display: none;">
          {% for application in template_data.applications %}
          <div class="card mb-3 application-card" data-status="{{ application.status }}">
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <h5 class="card-title">
                    <a href="{% url 'jobs.detail' application.job.id %}" class="text-decoration-none">
                      {{ application.job.title }}
                    </a>
                    <span class="badge bg-{{ application.get_status_color }} ms-2">
                      {{ application.get_status_display }}
                    </span>
                  </h5>
                  <h6 class="card-subtitle mb-2 text-muted">{{ application.job.company }}</h6>
                  <p class="card-text">
                    <i class="fas fa-map-marker-alt"></i> {{ application.job.location }} |
                    <i class="fas fa-briefcase"></i> {{ application.job.get_job_type_display }} |
                    <i class="fas fa-user-tie"></i> {{ application.job.get_experience_level_display }}
                  </p>
                  <p class="card-text">{{ application.job.description|truncatewords:30 }}</p>
                </div>
                <div class="col-md-4 text-end">
                  <div class="mb-2">
                    <span class="badge bg-success fs-6">{{ application.job.salary_range }}</span>
                  </div>
                  <small class="text-muted">
                    Applied {{ application.applied_at|timesince }} ago
                  </small>
                  {% if application.reviewed_at %}
                  <br>
                  <small class="text-muted">
                    Last updated {{ application.reviewed_at|timesince }} ago
                  </small>
                  {% endif %}
                  <div class="mt-2">
                    <a href="{% url 'jobs.detail' application.job.id %}" class="btn btn-outline-primary btn-sm">
                      View Job
                    </a>
                  </div>
                </div>
              </div>
              
              <!-- Application Details -->
              <hr>
              <div class="row">
                <div class="col-12">
                  <h6>Your Cover Note:</h6>
                  <p class="text-muted">{{ application.cover_note|linebreaks }}</p>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        {% else %}
        <div class="text-center py-5">
          <i class="fas fa-search fa-3x text-muted mb-3"></i>
          <h4>No applications yet</h4>
          <p class="text-muted">Start applying to jobs to track your application status here!</p>
          <a href="{% url 'jobs.list' %}" class="btn btn-primary">
            <i class="fas fa-search"></i> Browse Jobs
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const boardViewBtn = document.getElementById('boardViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const boardView = document.getElementById('boardView');
    const listView = document.getElementById('listView');
    
    // Toggle between board and list views
    boardViewBtn.addEventListener('click', function() {
        boardView.style.display = 'block';
        listView.style.display = 'none';
        boardViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
        localStorage.setItem('applicationsView', 'board');
    });
    
    listViewBtn.addEventListener('click', function() {
        boardView.style.display = 'none';
        listView.style.display = 'block';
        listViewBtn.classList.add('active');
        boardViewBtn.classList.remove('active');
        localStorage.setItem('applicationsView', 'list');
    });
    
    // Remember user preference
    const savedView = localStorage.getItem('applicationsView');
    if (savedView === 'list') {
        listViewBtn.click();
    }
    
    // Drag and Drop for Board View
    const cards = document.querySelectorAll('.application-card[draggable="true"]');
    const dropZones = document.querySelectorAll('.kanban-drop-zone');
    
    cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        
        // Touch events for mobile
        card.addEventListener('touchstart', handleTouchStart, { passive: false });
        card.addEventListener('touchmove', handleTouchMove, { passive: false });
        card.addEventListener('touchend', handleTouchEnd, { passive: false });
    });
    
    dropZones.forEach(zone => {
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('drop', handleDrop);
        zone.addEventListener('dragleave', handleDragLeave);
    });
    
    let draggedElement = null;
    let touchClone = null;
    let touchStartTime = 0;
    let touchHoldTimer = null;
    let isDraggingTouch = false;
    let touchStartX = 0;
    let touchStartY = 0;
    
    // Touch event handlers for mobile
    function handleTouchStart(e) {
        touchStartTime = Date.now();
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        
        // Long press to start drag (500ms)
        touchHoldTimer = setTimeout(() => {
            isDraggingTouch = true;
            draggedElement = this;
            this.classList.add('dragging');
            
            // Create a clone for visual feedback
            touchClone = this.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.zIndex = '10000';
            touchClone.style.opacity = '0.8';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.width = this.offsetWidth + 'px';
            touchClone.style.transform = 'rotate(3deg)';
            document.body.appendChild(touchClone);
            
            updateTouchClonePosition(e.touches[0].clientX, e.touches[0].clientY);
            
            // Haptic feedback if available
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }, 500);
    }
    
    function handleTouchMove(e) {
        if (!isDraggingTouch) {
            // Cancel long press if finger moves too much before drag starts
            const moveX = Math.abs(e.touches[0].clientX - touchStartX);
            const moveY = Math.abs(e.touches[0].clientY - touchStartY);
            if (moveX > 10 || moveY > 10) {
                clearTimeout(touchHoldTimer);
            }
            return;
        }
        
        e.preventDefault();
        
        const touch = e.touches[0];
        updateTouchClonePosition(touch.clientX, touch.clientY);
        
        // Find which drop zone the touch is over
        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        const dropZone = elementBelow?.closest('.kanban-drop-zone');
        
        // Update visual feedback
        dropZones.forEach(zone => zone.classList.remove('drag-over'));
        if (dropZone) {
            dropZone.classList.add('drag-over');
        }
    }
    
    function handleTouchEnd(e) {
        clearTimeout(touchHoldTimer);
        
        if (!isDraggingTouch) return;
        
        e.preventDefault();
        
        const touch = e.changedTouches[0];
        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        const dropZone = elementBelow?.closest('.kanban-drop-zone');
        
        // Clean up
        if (touchClone) {
            touchClone.remove();
            touchClone = null;
        }
        
        draggedElement.classList.remove('dragging');
        dropZones.forEach(zone => zone.classList.remove('drag-over'));
        
        if (dropZone && draggedElement) {
            const newStatus = dropZone.dataset.status;
            const oldStatus = draggedElement.dataset.status;
            
            if (newStatus !== oldStatus) {
                const applicationId = draggedElement.dataset.applicationId;
                
                // Move card to new column
                dropZone.insertBefore(draggedElement, dropZone.querySelector('.empty-message'));
                draggedElement.dataset.status = newStatus;
                
                // Hide empty messages
                dropZone.querySelector('.empty-message')?.remove();
                
                // Update status on server
                updateApplicationStatus(applicationId, newStatus);
                
                // Haptic feedback if available
                if (navigator.vibrate) {
                    navigator.vibrate([50, 100, 50]);
                }
            }
        }
        
        isDraggingTouch = false;
        draggedElement = null;
    }
    
    function updateTouchClonePosition(x, y) {
        if (touchClone) {
            touchClone.style.left = (x - touchClone.offsetWidth / 2) + 'px';
            touchClone.style.top = (y - touchClone.offsetHeight / 2) + 'px';
        }
    }
    
    // Mouse drag handlers
    function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }
    
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        dropZones.forEach(zone => zone.classList.remove('drag-over'));
    }
    
    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
        return false;
    }
    
    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        
        this.classList.remove('drag-over');
        
        if (draggedElement) {
            const newStatus = this.dataset.status;
            const oldStatus = draggedElement.dataset.status;
            
            if (newStatus !== oldStatus) {
                const applicationId = draggedElement.dataset.applicationId;
                
                // Move card to new column
                this.insertBefore(draggedElement, this.querySelector('.empty-message'));
                draggedElement.dataset.status = newStatus;
                
                // Hide empty messages
                this.querySelector('.empty-message')?.remove();
                
                // Update status on server
                updateApplicationStatus(applicationId, newStatus);
            }
        }
        
        return false;
    }
});

function updateApplicationStatus(applicationId, status) {
    const formData = new FormData();
    formData.append('status', status);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/jobs/applications/${applicationId}/update-status/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update status counts
            updateStatusCounts();
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <strong>Success!</strong> Application moved to ${data.new_status}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 3000);
            
            // Update list view badge if exists
            const listCards = document.querySelectorAll('#listView .application-card');
            listCards.forEach(card => {
                if (card.querySelector(`[data-application-id="${applicationId}"]`) || 
                    card.dataset.applicationId === applicationId) {
                    const badge = card.querySelector('.badge');
                    if (badge) {
                        badge.className = `badge bg-${data.status_color} ms-2`;
                        badge.textContent = data.new_status;
                    }
                }
            });
        } else {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <strong>Error!</strong> ${data.error}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 3000);
            
            // Revert the move
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Revert the move
        location.reload();
    });
}

function updateStatusCounts() {
    document.querySelectorAll('.kanban-drop-zone').forEach(zone => {
        const status = zone.dataset.status;
        const count = zone.querySelectorAll('.application-card').length;
        const badge = document.querySelector(`.status-count[data-status="${status}"]`);
        if (badge) {
            badge.textContent = count;
        }
        
        // Show/hide empty message
        const emptyMessage = zone.querySelector('.empty-message');
        if (count === 0 && !emptyMessage) {
            zone.innerHTML = `
                <div class="text-center text-muted py-3 empty-message">
                    <i class="fas fa-inbox"></i>
                    <br>
                    <small>No applications</small>
                </div>
            `;
        }
    });
}
</script>

<style>
.application-card {
    transition: transform 0.2s ease-in-out, opacity 0.2s;
    cursor: move;
    touch-action: none;
    -webkit-user-select: none;
    user-select: none;
}

.application-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
}

.application-card.dragging {
    opacity: 0.5;
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.125);
}

.kanban-drop-zone {
    transition: background-color 0.2s;
}

.kanban-drop-zone.drag-over {
    background-color: #e3f2fd !important;
    border: 2px dashed #2196F3;
}

/* Kanban board styling */
#boardView .row {
    margin: 0;
}

#boardView .col {
    flex: 1;
    min-width: 0;
    max-width: none;
}

/* Ensure equal width columns that span full width */
#boardView .row > .col {
    flex-basis: 0;
    flex-grow: 1;
}

/* Mobile responsive */
@media (max-width: 768px) {
    #boardView .col {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 1rem;
    }
    
    #boardView .row {
        flex-direction: column;
    }
    
    /* Better touch targets on mobile */
    .application-card {
        cursor: grab;
    }
    
    .application-card.dragging {
        cursor: grabbing;
    }
}

/* Tablet responsive */
@media (min-width: 769px) and (max-width: 1024px) {
    #boardView .col {
        flex: 0 0 calc(50% - 0.5rem);
        max-width: calc(50% - 0.5rem);
    }
}
</style>
{% endblock content %}